{% extends "layout.html" %}
{% block content %}
    <script>

        function template(post) {

            let liked = '';
            let icon = 'r';

            if(post.like == true) {
                liked = 'd';
                icon = 's';
            }
            
            let content = `<div class="card article">
                    <div class="card-header">
                        <img  class="account-img rounded-circle" src="${post.author.image_file}">
                        <a class="text-dark user-link" href="${post.author.user_url}">${post.author.username}</a>
                    </div>
            
                        <div class="main-img-wrapper bg-light">
                            <img src="${post.media}" class="card-img-top post-media rounded-0" alt="">
                        </div>

                    <div class="card-body pb-2">
                        <div class="card-text post-meta-data">
                            <span id="l-${post.pid}" class="up-info like${liked}"><i class='fa${icon} fa-heart'></i></span>
        
                            <span class="up-info"><i class="far fa-comment"></i></span>
                            <span class="up-info"><i class="fa fa-share"></i></span>
                            
                            
                            <small class=""><a class="float-right text-muted" href="${post.post_url}">View</a></small>
        
                            <div class="like-counter">
                                <span id="like-${post.pid}" class="like-count">${post.like_count}</span>
                                likes
                            </div>
                    
                        </div>`;
                        if(post.content.length > 0 ) {
                            content = content + 
                            `<span class="card-text"> 
                                    <a class="text-dark user-link " href="${post.author.user_url}">${post.author.username}</a>
                                    ${post.content}
                            </span>`;
                        }
                        content = content + 
                        `<div class="comments" id="comments-on-${post.pid}">`;
                            if (post.comment_count > 2) {
                                content = content + 
                                `<a class="text-muted" href="${post.post_url}">View all ${post.comment_count} comments</a>`;
                            }
                            post.comments.forEach(comment => {
                                content = content + 
                                `<span class="comment" id="c${comment.cid }">
                                <a class="text-dark user-link" href="${comment.author.user_url}">${comment.author.username}</a>
                                    ${comment.content}
                                </span>`
                            });
                        content = content + `</div>
                        <small class="text-muted text-uppercase">${post.timeago}</small>
                    </div>
        
                    <div class="modal-footer home-comment-box">
                        <ul class="list-group list-group-flush" style="width: 85%;">
                            <textarea class="text-muted comment-box make-comment" id="comment-on-${post.pid}" placeholder="Add a comment.."></textarea>
                        </ul>
                        <button class="btn post-comment" id="c-${post.pid}">Post</button>
                </div>
            </div>`;

                return content;
        };


        let page_count = 1;
        let end_reached = false;
    
        document.addEventListener('DOMContentLoaded', () => {
            load_posts(page_count++);

            window.onscroll = () => {
                // check if we reached the bottom
                if(window.innerHeight + window.scrollY >= document.body.offsetHeight && end_reached == false) {
                    // alert("bottom");
                    load_posts(page_count++);
                }
            }; 
        });


        function load_posts(start) {
            // init a new request
            const req = new XMLHttpRequest();
            req.open('POST', $SCRIPT_ROOT + '/')

            // callback function when data is loaded
            req.onload = () => {
                // extract data
                const data = JSON.parse(req.responseText);
                
                if (data.success) {
                    if(data.result.length === 0) {
                        end_reached = true;
                        return false;
                    }
                    // loads posts
                    data.result.forEach(post => {
                        // add new post
                        const content = template(post);
                        $('.special').append(content);
                        // add event handlers
                        document.querySelector(`#l-${post.pid}`).onclick = like_post;
                        document.querySelector(`#c-${post.pid}`).onclick = comment_handler;
                        document.querySelector(`#c-${post.pid}`).disabled = true;
                        document.querySelector(`#comment-on-${post.pid}`).onkeyup = enable_disable_button;
                    });

                }
                else
                    alert("Something went wrong", data.result);
            };

            // add data
            const param = new FormData();
            param.append('start', start);

            // Send request
            req.send(param);
        };
    
    </script>

{% endblock content %}